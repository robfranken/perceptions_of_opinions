---
title: "Social influence on (mis)perception"
bibliography: references.bib
link-citations: true
author: "Rob Franken"
output: 
  html_document:
    css: tweaks.css
    toc:  true
    toc_float: true
    number_sections: false
    toc_depth: 1
    code_folding: show
    code_download: yes
---

```{r, globalsettings, echo=FALSE, warning=FALSE, results='hide'}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE, warning = FALSE, message = FALSE,comment = "#>", cache=TRUE, class.source=c("test"), class.output=c("test3"))
options(width = 100)
rgl::setupKnitr()
```


```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c('top', 'right'))
#klippy::klippy(color = 'darkred')
#klippy::klippy(tooltip_message = 'Click to copy', tooltip_success = 'Done')
```

Last compiled on `r format(Sys.time(), '%d-%m-%Y')`

---  

# Getting started

To copy the code, click the button in the upper right corner of the code-chunks.

## clean up

```{r, results='hide'}
rm(list=ls())
gc()
```

<br>


## general custom functions

- `fpackage.check`: Check if packages are installed (and install if not) in R
- `fsave`: Function to save data with time stamp in correct directory
- `fload`: Function to load R-objects under new names
- `fshowdf`: Print objects (`tibble` / `data.frame`) nicely on screen in `.Rmd`
- `fanscsv`: Tweaking Siena output ([source](https://jochemtolsma.github.io/Twitter/))


```{r, fun}
fpackage.check <- function(packages) {
    lapply(packages, FUN = function(x) {
        if (!require(x, character.only = TRUE)) {
            install.packages(x, dependencies = TRUE)
            library(x, character.only = TRUE)
        }
    })
}

fsave <- function(x, location = "./data/processed/") {
  if (location == "./data/processed/") {
  ifelse(!dir.exists("data"), dir.create("data"), FALSE)
  ifelse(!dir.exists("data/processed"), dir.create("data/processed"), FALSE)
  }

  object = deparse(substitute(x))
  datename <- substr(gsub("[:-]", "", Sys.time()), 1, 8)
  totalname <- paste(location, object, "_", datename,  ".rda", sep = "")
  assign(eval(object), x, envir = .GlobalEnv)
  print(paste("SAVED: ", totalname, sep = ""))
  save(list = object, file = totalname)  
}

fload  <- function(fileName){
  load(fileName)
  get(ls()[ls() != "fileName"])
}

fshowdf <- function(x, caption = NULL, digits = 2, footnote = NULL, ...) {
    knitr::kable(x, digits = digits, "html", caption = caption, ...) %>%
        kableExtra::footnote(general = footnote) %>%
        kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
        kableExtra::scroll_box(width = "100%", height = "300px")
}

fanscsv <- function(ans = ans) {
  ans1_mat <- matrix(NA, nrow = length(ans$effects[, 2]), ncol = 3)
  row.names(ans1_mat) <- ans$effects[, 2]
  ans1_mat[, 1] <- (ans$theta)
  ans1_mat[, 2] <- (ans$se)
  ans1_mat[, 3] <- (ans$tconv)
  ans1_mat <- rbind(ans1_mat, c(ans$tconv.max))
  row.names(ans1_mat)[length(row.names(ans1_mat))] <- "Overall maximum convergence ratio:"
  colnames(ans1_mat) <- c("Estimate", "Standard Error", "Convergence t-ratio")
  return(ans1_mat)
  # print(ans1_mat)
  # write.csv(ans1_mat, filename)
}
```

<br>

## necessary packages

- `tidyverse`: data wrangling
- `RSiena`: stochastic actor-oriented model


```{r, packages, message=FALSE, results='hide'}
packages = c("tidyverse", "RSiena", "knitr", "kableExtra")
fpackage.check(packages)
rm(packages)
```

<br>

---

# Import

Import the replicated data-sets. You may obtain it by downloading: `r xfun::embed_file("./data_shared/zieelkaar_siena.Rda")` 

```{r, data}
#list.files("./data/processed")
today <- gsub("-", "", Sys.Date())
today <- "20250903" #latest updated dataset

class_data <- fload(paste0("./data/processed/", today, "zieelkaar_siena.Rda"))
```

---

# stationary SAOM

See @krause2018; @snijders2013

```{r}
# get one class, and take the perceive-as-right network
mydata <- class_data[[2]]$right

# inspect print01Report(class, modelname='test')
```

<br>

## effects

```{r, saom, eval=FALSE}
# define a model
myeff <- getEffects(mydata)

# starting with simple model
# tendency to perceive those as "right", who are perceived by many others as right
myeff <- includeEffects(myeff, inPop, name = "perception")

# tendency for those perceiving many others as "right" to perceive alter also as "right"
myeff <- includeEffects(myeff, outAct, name = "perception")

# tendency for self-reported "rights" to perceive more others as right (projection)
myeff <- includeEffects(myeff, egoX, name = "perception", interaction1 = "self")

# tendency for self-reported rights to be perceived as such
myeff <- includeEffects(myeff, altX, name = "perception", interaction1 = "self")

# friendship effects:
myeff <- includeEffects(myeff, transTrip, outAct, inPop, name = "friend")
myeff <- includeEffects(myeff, egoX, altX, egoXaltX, outAct, inPop, name = "friend")

# for more complex models, consider cross-network effects (friendship-->perception);
# we fix and test them for now:

# ego's tendency to perceive those as right who are befriended by many others whom ego perceives as right
myeff <- includeEffects(myeff, cl.XWX1, name = "perception", interaction1 = "friend", fix = TRUE, test = TRUE)
# ego's tendency to accept their friends' perceptions about alter
myeff <- includeEffects(myeff, to, name = "perception", interaction1 = "friend",  fix = TRUE, test = TRUE)

# !! fix the rate parameter to a high value (for the stationary saom)
# needs to be sufficiently high to give the simulation enough time to "get away" from the starting network and reach an equilibrium state.

rate = 20
myeff <- setEffect(myeff, Rate, type = "rate", fix = TRUE, initialValue = rate, name = "friend")
myeff <- setEffect(myeff, Rate, type = "rate", fix = TRUE, initialValue = rate, name = "perception")
``` 
<br>

## estimation

```{r, eval = FALSE}
myalgo <- sienaAlgorithmCreate(projname = "stationary_saom_class1_right", nsub = 5, n3 = 1e3)
ncores <- parallel::detectCores()

ans <- siena07(
  myalgo,
  data = mydata,
  effects = myeff,
  #returnDeps = TRUE,
  useCluster = TRUE,
  nbrNodes = ncores,
  initC = TRUE,
  batch = TRUE
)

save(ans, file = paste("./results/ans1.RDa"))

#?score.Test
#score.Test(ans, 14)
#score.Test(ans, 15) # score-test suggest that these influence effects should be included!

myeff2 <- includeEffects(myeff, cl.XWX1, name = "perception", interaction1 = "friend", fix = FALSE, test = FALSE)
myeff2 <- includeEffects(myeff2, to, name = "perception", interaction1 = "friend",  fix = FALSE, test = FALSE)

max_tries <- 10
try_count <- 1
converged <- FALSE

ans_new <- siena07(
  myalgo,
  data = mydata,
  effects = myeff2,
  prevAns = ans,
  #returnDeps = TRUE,
  useCluster = TRUE,
  nbrNodes = ncores,
  initC = TRUE,
  batch = TRUE
)

while (!converged && try_count <= max_tries) {
  tconv <- ans_new$tconv.max
  
  if (tconv < 0.25) {
    converged <- TRUE
    message(paste("Model converges. Maximum convergence ratio:", round(tconv, 3)))
    break
  } else {
    try_count <- try_count + 1
    message(paste("Model did not converge adequately (", round(tconv, 3),
                  "); repeating estimation (try ", try_count, ")", sep=""))
    
    ans_new <- siena07(
      myalgo,
      data = mydata,
      effects = myeff2,
      prevAns = ans_new,
      #returnDeps = TRUE,
      useCluster = TRUE,
      nbrNodes = ncores,
      initC = TRUE,
      batch = TRUE
    )
  }
}

if (!converged) {
  warning("Model did not converge after ", max_tries, " tries.")
}

ans2 <- siena07(
  myalgo,
  data = mydata,
  effects = myeff,
  #returnDeps = TRUE,
  useCluster = TRUE,
  nbrNodes = ncores,
  initC = TRUE,
  batch = TRUE
)

while (!converged && try_count <= max_tries) {
  tconv <- ans2$tconv.max
  
  if (tconv < 0.25) {
    converged <- TRUE
    message(paste("Model converges. Maximum convergence ratio:", round(tconv, 3)))
    break
  } else {
    try_count <- try_count + 1
    message(paste("Model did not converge adequately (", round(tconv, 3),
                  "); repeating estimation (try ", try_count, ")", sep=""))
    
    ans <- siena07(
      myalgo,
      data = mydata,
      effects = myeff,
      prevAns = ans,
      #returnDeps = TRUE,
      useCluster = TRUE,
      nbrNodes = ncores,
      initC = TRUE,
      batch = TRUE
    )
  }
}
if (!converged) {
  warning("Model did not converge after ", max_tries, " tries.")
}
``` 

<br>

## results

```{r,  class.source = 'fold-hide'}
ans <- fload("./results/ans1.Rda")

#extract estimates
res <- round(fanscsv(ans)[-c(14:16), 1:2], 5)  # exclude last rows (tested effects; convergence info)
mc <- as.character(round(fanscsv(ans)[13, 1], 3))  # maximum convergence ratio

# add row names
row.names(res) <- c(
  "rate ", "outdegree", "reciprocity",
  "transitive triplets", "indegree popularity", "outdegree activity",
  "rate", "outdegree", "reciprocity", "indegree popularity", "outdegree activity", "self-report (alter)", "self-report (ego)") 

asmatkable <- kbl(res, booktabs = TRUE, digits = 3, caption = "Model 1", align = "c") %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(column = 1, width = "3in") %>%
  #row_spec(c(11, 24, 41), bold = TRUE, color = "white", background = "#D7261E") %>%
  group_rows(index = c("Friendship" = 6, "Perception" = 7)) %>%
  footnote(general = paste("Overall maximum convergence ratio: ", mc, sep = ""))

asmatkable
```


----

## References